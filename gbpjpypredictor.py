import pandas as pd
import numpy as np
from sklearn.linear_model import LinearRegression
from sklearn.multioutput import MultiOutputRegressor
import datetime

############################################################################
# 1) MANUAL DATA for GBPJPY (2024-01-02 through 2025-01-02)
#    We'll store the daily data you provided: columns = [Date, Open, High, Low, Close]
#    Then we want to predict: 2025-01-03
############################################################################

data_rows = [
    # Date       Open     High      Low     Close
    # January 2024
    ["2024-01-02", 179.156, 180.645, 178.731, 179.122],
    ["2024-01-03", 179.104, 181.736, 178.726, 181.466],
    ["2024-01-04", 181.463, 183.777, 180.988, 183.413],
    ["2024-01-05", 183.232, 184.327, 183.158, 183.908],
    ["2024-01-08", 183.724, 184.200, 183.016, 183.856],
    ["2024-01-09", 183.846, 183.910, 182.747, 183.581],
    ["2024-01-10", 183.599, 185.740, 183.365, 185.713],
    ["2024-01-11", 185.740, 186.160, 184.899, 185.302],
    ["2024-01-12", 185.137, 185.638, 184.469, 184.777],
    ["2024-01-15", 184.553, 185.751, 184.394, 185.446],
    ["2024-01-16", 185.450, 186.181, 184.954, 185.984],
    ["2024-01-17", 185.999, 188.117, 185.671, 187.805],
    ["2024-01-18", 187.804, 188.253, 187.181, 188.233],
    ["2024-01-19", 188.247, 188.902, 187.405, 188.205],
    ["2024-01-22", 188.006, 188.370, 187.737, 188.204],
    ["2024-01-23", 188.205, 188.898, 187.331, 188.175],
    ["2024-01-24", 188.184, 188.473, 187.116, 187.696],
    ["2024-01-25", 187.700, 188.191, 187.150, 187.631],
    ["2024-01-26", 187.633, 188.566, 187.289, 188.164],
    ["2024-01-29", 187.657, 188.270, 187.110, 187.432],
    ["2024-01-30", 187.451, 187.494, 186.334, 187.431],
    ["2024-01-31", 187.431, 187.617, 185.904, 186.374],

    # February 2024
    ["2024-02-01", 186.375, 186.601, 185.159, 186.583],
    ["2024-02-02", 186.588, 187.729, 186.243, 187.404],
    ["2024-02-05", 187.341, 187.609, 185.976, 186.369],
    ["2024-02-06", 186.367, 186.780, 186.149, 186.349],
    ["2024-02-07", 186.350, 187.256, 186.068, 187.084],
    ["2024-02-08", 187.087, 188.465, 186.774, 188.394],
    ["2024-02-09", 188.396, 188.862, 188.100, 188.469],
    ["2024-02-12", 188.322, 188.701, 187.842, 188.603],
    ["2024-02-13", 188.604, 190.055, 188.358, 189.907],
    ["2024-02-14", 189.873, 189.873, 188.743, 189.192],
    ["2024-02-15", 189.181, 189.204, 187.890, 188.875],
    ["2024-02-16", 188.880, 189.493, 188.528, 189.248],
    ["2024-02-19", 189.081, 189.379, 188.890, 189.050],
    ["2024-02-20", 189.020, 189.714, 188.821, 189.335],
    ["2024-02-21", 189.330, 189.940, 189.073, 189.915],
    ["2024-02-22", 189.914, 190.821, 189.751, 190.572],
    ["2024-02-23", 190.571, 191.132, 190.336, 190.707],
    ["2024-02-26", 190.750, 191.309, 190.309, 191.157],
    ["2024-02-27", 190.990, 191.157, 190.356, 190.873],
    ["2024-02-28", 190.901, 190.922, 190.244, 190.778],
    ["2024-02-29", 190.786, 190.796, 189.031, 189.301],

    # March 2024
    ["2024-03-01", 189.326, 190.384, 189.011, 189.914],
    ["2024-03-04", 189.850, 191.181, 189.678, 191.009],
    ["2024-03-05", 191.011, 191.050, 190.288, 190.661],
    ["2024-03-06", 190.654, 190.673, 189.843, 190.174],
    ["2024-03-07", 190.140, 190.173, 188.217, 189.613],
    ["2024-03-08", 189.608, 189.685, 188.371, 189.060],
    ["2024-03-11", 188.993, 189.013, 187.909, 188.277],
    ["2024-03-12", 188.215, 189.171, 187.948, 188.839],
    ["2024-03-13", 188.839, 189.544, 188.408, 188.905],
    ["2024-03-14", 188.913, 189.513, 188.591, 189.105],
    ["2024-03-15", 189.105, 190.024, 188.579, 189.801],
    ["2024-03-18", 189.787, 190.152, 189.527, 189.777],
    ["2024-03-19", 189.783, 192.159, 189.620, 191.792],
    ["2024-03-20", 191.792, 193.524, 191.744, 193.264],
    ["2024-03-21", 193.264, 193.496, 191.775, 191.854],
    ["2024-03-22", 191.854, 192.227, 190.379, 190.776],
    ["2024-03-25", 190.726, 191.567, 190.335, 191.299],
    ["2024-03-26", 191.299, 191.671, 191.095, 191.195],
    ["2024-03-27", 191.195, 191.522, 190.498, 191.064],
    ["2024-03-28", 191.062, 191.312, 190.561, 190.997],
    ["2024-03-29", 191.002, 191.229, 190.771, 190.990],

    # April 2024
    ["2024-04-01", 190.820, 191.350, 190.173, 190.322],
    ["2024-04-02", 190.327, 190.711, 190.038, 190.608],
    ["2024-04-03", 190.604, 191.928, 190.418, 191.918],
    ["2024-04-04", 191.916, 192.243, 191.007, 191.318],
    ["2024-04-05", 191.317, 191.626, 190.669, 191.575],
    ["2024-04-08", 191.297, 192.186, 191.292, 192.125],
    ["2024-04-09", 192.119, 192.847, 191.793, 192.410],
    ["2024-04-10", 192.404, 192.924, 191.466, 192.049],
    ["2024-04-11", 192.065, 192.573, 191.556, 192.366],
    ["2024-04-12", 192.374, 192.395, 189.986, 190.795],
    ["2024-04-15", 190.480, 192.709, 190.204, 191.992],
    ["2024-04-16", 191.985, 192.806, 191.642, 192.226],
    ["2024-04-17", 192.228, 192.830, 191.669, 192.255],
    ["2024-04-18", 192.264, 192.774, 191.893, 192.303],
    ["2024-04-19", 192.289, 192.721, 190.293, 191.254],
    ["2024-04-22", 191.320, 191.693, 190.316, 191.220],
    ["2024-04-23", 191.222, 192.843, 190.828, 192.734],
    ["2024-04-24", 192.726, 193.627, 192.336, 193.605],
    ["2024-04-25", 193.605, 194.943, 193.106, 194.759],
    ["2024-04-26", 194.757, 197.905, 193.958, 197.812],
    ["2024-04-29", 197.030, 200.539, 193.603, 196.412],
    ["2024-04-30", 196.398, 197.369, 195.930, 197.111],

    # May 2024
    ["2024-05-01", 196.986, 197.420, 191.766, 193.681],
    ["2024-05-02", 193.623, 195.744, 191.850, 192.624],
    ["2024-05-03", 192.549, 192.644, 191.352, 191.884],
    ["2024-05-06", 191.820, 193.664, 191.539, 193.296],
    ["2024-05-07", 193.285, 194.124, 192.982, 193.484],
    ["2024-05-08", 193.483, 194.510, 193.012, 194.379],
    ["2024-05-09", 194.373, 194.854, 193.833, 194.712],
    ["2024-05-10", 194.698, 195.337, 194.357, 195.075],
    ["2024-05-13", 194.890, 196.275, 194.735, 196.165],
    ["2024-05-14", 196.158, 197.051, 195.713, 196.944],
    ["2024-05-15", 196.916, 197.089, 195.877, 196.456],
    ["2024-05-16", 196.472, 196.905, 195.036, 196.839],
    ["2024-05-17", 196.856, 197.849, 196.671, 197.647],
    ["2024-05-20", 197.480, 198.639, 197.253, 198.522],
    ["2024-05-21", 198.503, 198.903, 198.267, 198.457],
    ["2024-05-22", 198.438, 199.531, 198.228, 199.365],
    ["2024-05-23", 199.371, 199.889, 199.018, 199.236],
    ["2024-05-24", 199.237, 200.062, 198.906, 199.892],
    ["2024-05-27", 199.870, 200.424, 199.610, 200.374],
    ["2024-05-28", 200.382, 200.643, 200.051, 200.528],
    ["2024-05-29", 200.536, 200.738, 200.047, 200.213],
    ["2024-05-30", 200.204, 200.235, 198.749, 199.605],
    ["2024-05-31", 199.642, 200.505, 199.238, 200.355],

    # June 2024
    ["2024-06-03", 200.220, 200.645, 199.221, 199.869],
    ["2024-06-04", 199.871, 200.416, 197.202, 197.788],
    ["2024-06-05", 197.833, 199.746, 197.482, 199.562],
    ["2024-06-06", 199.543, 199.935, 198.831, 199.018],
    ["2024-06-07", 198.875, 199.808, 198.392, 199.363],
    ["2024-06-10", 199.450, 200.044, 198.930, 199.869],
    ["2024-06-11", 199.867, 200.392, 199.625, 200.175],
    ["2024-06-12", 200.168, 200.933, 199.854, 200.550],
    ["2024-06-13", 200.550, 201.311, 199.688, 200.389],
    ["2024-06-14", 200.382, 201.612, 198.918, 199.654],
    ["2024-06-17", 199.650, 200.449, 199.058, 200.378],
    ["2024-06-18", 200.343, 200.844, 200.015, 200.618],
    ["2024-06-19", 200.623, 201.112, 200.244, 201.062],
    ["2024-06-20", 201.081, 201.389, 200.788, 201.151],
    ["2024-06-21", 201.152, 202.044, 200.449, 202.003],
    ["2024-06-24", 201.899, 202.697, 201.129, 202.470],
    ["2024-06-25", 202.428, 202.724, 201.959, 202.586],
    ["2024-06-26", 202.552, 203.145, 202.301, 202.973],
    ["2024-06-27", 202.858, 203.382, 202.501, 203.176],
    ["2024-06-28", 203.189, 203.589, 202.563, 203.424],

    # July 2024
    ["2024-07-01", 203.440, 204.724, 203.198, 204.254],
    ["2024-07-02", 204.197, 204.383, 203.882, 204.126],
    ["2024-07-03", 204.803, 206.164, 204.421, 206.042],
    ["2024-07-04", 206.032, 206.069, 205.284, 205.775],
    ["2024-07-05", 205.765, 206.435, 204.983, 206.023],
    ["2024-07-08", 205.700, 206.664, 205.288, 205.956],
    ["2024-07-09", 205.918, 206.582, 205.828, 206.281],
    ["2024-07-10", 206.268, 207.814, 206.015, 207.725],
    ["2024-07-11", 207.733, 208.110, 203.824, 205.150],
    ["2024-07-12", 205.142, 206.336, 203.814, 205.029],
    ["2024-07-15", 205.050, 205.397, 204.133, 204.998],
    ["2024-07-16", 204.902, 205.787, 204.769, 205.441],
    ["2024-07-17", 205.298, 205.688, 203.016, 203.212],
    ["2024-07-18", 203.135, 203.862, 202.095, 203.673],
    ["2024-07-19", 203.680, 204.217, 202.945, 203.288],
    ["2024-07-22", 203.037, 203.608, 201.889, 203.046],
    ["2024-07-23", 203.041, 203.156, 200.743, 200.799],
    ["2024-07-24", 200.788, 201.177, 197.768, 198.575],
    ["2024-07-25", 198.593, 198.796, 195.860, 197.833],
    ["2024-07-26", 197.849, 199.139, 196.896, 197.752],
    ["2024-07-29", 197.620, 198.603, 196.784, 198.080],
    ["2024-07-30", 198.054, 199.464, 195.975, 196.049],
    ["2024-07-31", 196.058, 197.545, 192.163, 192.800],

    # August 2024
    ["2024-08-01", 192.794, 193.249, 190.159, 190.258],
    ["2024-08-02", 190.320, 190.500, 187.381, 187.553],
    ["2024-08-05", 187.562, 187.628, 180.075, 184.211],
    ["2024-08-06", 184.213, 187.070, 182.803, 183.134],
    ["2024-08-07", 183.131, 188.063, 182.902, 186.128],
    ["2024-08-08", 186.129, 187.868, 184.469, 187.709],
    ["2024-08-09", 187.700, 188.406, 186.470, 187.007],
    ["2024-08-12", 186.946, 189.321, 186.896, 187.915],
    ["2024-08-13", 187.914, 189.504, 187.572, 188.839],
    ["2024-08-14", 188.863, 189.422, 187.852, 189.000],
    ["2024-08-15", 188.866, 191.999, 188.747, 191.887],
    ["2024-08-16", 191.846, 192.001, 190.367, 190.975],
    ["2024-08-19", 191.002, 191.620, 188.229, 190.407],
    ["2024-08-20", 190.338, 191.256, 189.222, 189.329],
    ["2024-08-21", 189.327, 191.404, 188.921, 190.080],
    ["2024-08-22", 190.154, 191.912, 189.625, 191.474],
    ["2024-08-23", 191.458, 192.019, 190.264, 190.673],
    ["2024-08-26", 190.321, 190.781, 189.499, 190.566],
    ["2024-08-27", 190.589, 191.914, 190.231, 190.879],
    ["2024-08-28", 190.818, 191.442, 190.348, 190.697],
    ["2024-08-29", 190.722, 191.535, 190.250, 190.950],
    ["2024-08-30", 190.956, 192.008, 190.487, 191.822],

    # September 2024
    ["2024-09-02", 191.765, 193.465, 191.326, 193.151],
    ["2024-09-03", 193.166, 193.351, 190.313, 190.764],
    ["2024-09-04", 190.737, 190.839, 188.922, 188.936],
    ["2024-09-05", 188.935, 189.774, 188.061, 189.054],
    ["2024-09-06", 188.970, 189.397, 186.512, 186.746],
    ["2024-09-09", 186.558, 188.121, 186.407, 187.177],
    ["2024-09-10", 187.189, 188.089, 185.721, 186.321],
    ["2024-09-11", 186.322, 186.363, 183.711, 185.666],
    ["2024-09-12", 185.640, 186.730, 185.281, 186.116],
    ["2024-09-13", 186.095, 186.198, 184.362, 184.739],
    ["2024-09-16", 184.658, 186.032, 183.763, 185.823],
    ["2024-09-17", 185.824, 187.448, 185.286, 187.409],
    ["2024-09-18", 187.401, 188.044, 185.823, 187.988],
    ["2024-09-19", 187.989, 190.383, 187.416, 189.445],
    ["2024-09-20", 189.439, 191.986, 188.708, 191.558],
    ["2024-09-23", 191.408, 192.428, 190.125, 191.659],
    ["2024-09-24", 191.644, 193.315, 191.230, 192.090],
    ["2024-09-25", 192.043, 193.254, 191.770, 192.851],
    ["2024-09-26", 192.844, 194.345, 192.503, 194.265],
    ["2024-09-27", 194.248, 195.956, 189.999, 190.093],
    ["2024-09-30", 190.041, 192.304, 189.553, 192.087],

    # October 2024
    ["2024-10-01", 192.082, 193.352, 189.846, 190.723],
    ["2024-10-02", 190.719, 194.416, 190.406, 194.297],
    ["2024-10-03", 194.330, 195.165, 192.116, 192.824],
    ["2024-10-04", 192.828, 195.519, 191.721, 195.101],
    ["2024-10-07", 194.873, 195.616, 193.338, 193.861],
    ["2024-10-08", 193.832, 194.366, 192.879, 194.197],
    ["2024-10-09", 194.179, 195.243, 193.581, 195.134],
    ["2024-10-10", 195.128, 195.496, 193.567, 194.030],
    ["2024-10-11", 193.947, 195.230, 193.738, 194.778],
    ["2024-10-14", 194.544, 195.706, 194.544, 195.556],
    ["2024-10-15", 195.564, 195.721, 194.638, 195.042],
    ["2024-10-16", 195.099, 195.275, 193.698, 194.358],
    ["2024-10-17", 194.386, 195.595, 193.825, 195.399],
    ["2024-10-18", 195.302, 196.046, 194.751, 195.066],
    ["2024-10-21", 194.980, 195.882, 194.562, 195.830],
    ["2024-10-22", 195.837, 196.510, 195.096, 196.132],
    ["2024-10-23", 196.137, 198.425, 195.688, 197.373],
    ["2024-10-24", 197.370, 197.622, 196.424, 196.987],
    ["2024-10-25", 196.982, 197.769, 196.377, 197.390],
    ["2024-10-28", 198.182, 199.347, 197.804, 198.734],
    ["2024-10-29", 198.733, 199.706, 198.032, 199.455],
    ["2024-10-30", 199.454, 199.797, 198.197, 198.761],
    ["2024-10-31", 198.720, 198.900, 195.372, 196.028],

    # November 2024
    ["2024-11-01", 196.027, 198.357, 195.776, 197.570],
    ["2024-11-04", 197.487, 197.792, 196.491, 197.100],
    ["2024-11-05", 197.102, 197.870, 196.922, 197.715],
    ["2024-11-06", 197.718, 199.516, 197.210, 199.120],
    ["2024-11-07", 199.001, 199.550, 198.293, 198.563],
    ["2024-11-08", 198.536, 198.913, 196.732, 197.173],
    ["2024-11-11", 197.036, 198.457, 196.625, 197.798],
    ["2024-11-12", 197.708, 198.051, 196.874, 197.074],
    ["2024-11-13", 196.989, 197.807, 196.650, 197.543],
    ["2024-11-14", 197.444, 198.234, 197.071, 197.892],
    ["2024-11-15", 197.883, 198.436, 194.293, 194.799],
    ["2024-11-18", 194.592, 196.143, 194.360, 196.048],
    ["2024-11-19", 196.035, 196.210, 193.555, 196.109],
    ["2024-11-20", 196.106, 197.777, 195.898, 196.554],
    ["2024-11-21", 196.578, 196.633, 194.363, 194.453],
    ["2024-11-22", 194.439, 194.802, 192.845, 193.911],
    ["2024-11-25", 194.027, 194.614, 193.265, 193.770],
    ["2024-11-26", 193.831, 193.831, 192.033, 192.415],
    ["2024-11-27", 192.417, 192.619, 190.687, 191.499],
    ["2024-11-28", 191.382, 192.464, 191.278, 192.209],
    ["2024-11-29", 192.126, 192.267, 190.154, 190.551],

    # December 2024
    ["2024-12-02", 190.378, 191.282, 188.465, 189.243],
    ["2024-12-03", 189.241, 190.373, 188.079, 189.487],
    ["2024-12-04", 189.497, 191.525, 189.354, 191.198],
    ["2024-12-05", 191.222, 192.206, 190.337, 191.422],
    ["2024-12-06", 191.433, 192.364, 190.718, 191.182],
    ["2024-12-09", 190.941, 193.401, 190.600, 192.725],
    ["2024-12-10", 192.801, 194.101, 192.422, 193.957],
    ["2024-12-11", 193.905, 194.773, 192.524, 194.280],
    ["2024-12-12", 194.375, 194.993, 192.930, 193.335],
    ["2024-12-13", 193.431, 194.452, 192.846, 193.869],
    ["2024-12-16", 193.820, 195.880, 193.646, 195.402],
    ["2024-12-17", 195.407, 195.892, 194.649, 194.934],
    ["2024-12-18", 194.953, 195.760, 194.070, 194.573],
    ["2024-12-19", 194.544, 198.941, 194.047, 196.725],
    ["2024-12-20", 196.762, 197.282, 195.745, 196.541],
    ["2024-12-23", 196.433, 197.072, 196.224, 196.863],
    ["2024-12-24", 196.825, 197.622, 196.590, 196.848],
    ["2024-12-26", 197.274, 197.991, 197.014, 197.834],
    ["2024-12-27", 197.745, 198.712, 197.208, 198.424],
    ["2024-12-30", 198.370, 198.950, 196.323, 196.792],
    ["2024-12-31", 196.766, 197.190, 195.737, 196.607],
    # We'll predict for 2025-01-03
    ["2025-01-02", 196.687, 197.521, 194.193, 194.856],
]

############################################################################
# 2) Build DataFrame
############################################################################

def load_gbpjpy_data():
    df = pd.DataFrame(data_rows, columns=["Date","Open","High","Low","Close"])
    df["Date"] = pd.to_datetime(df["Date"])
    df.set_index("Date", inplace=True)
    df.sort_index(inplace=True)
    return df

############################################################################
# 3) CLEAN + FEATURE ENGINEERING
############################################################################

def clean_data(df):
    # Sort, remove dups, drop NaNs if any
    df.sort_index(inplace=True)
    df = df[~df.index.duplicated(keep='first')]
    df.dropna(inplace=True)
    return df

def build_dataset_for_next_day(df, lookback=5):
    """
    We'll do a simple approach:
      - For each day t, we gather the last 'lookback' days of (Open,High,Low,Close).
      - Flatten them as features. 
      - Target = tomorrow's [High,Low,Close].
    """
    X_list = []
    Y_list = []
    dates_list = []
    arr = df[["Open","High","Low","Close"]].values  # shape (N,4)
    all_dates = df.index.to_list()

    for i in range(lookback, len(df)-1):
        # i is the "today" row
        past_window = arr[i-lookback : i]   # shape (lookback,4)
        future_day  = arr[i+1]              # tomorrow => [Open,High,Low,Close]

        # Flatten the past window
        feats = past_window.flatten()  # shape( lookback*4, )
        X_list.append(feats)

        # We'll predict tomorrow's High, Low, Close
        f_high = future_day[1]
        f_low  = future_day[2]
        f_close= future_day[3]
        Y_list.append([f_high, f_low, f_close])

        # Store the date that these features label
        #   i corresponds to "today", i+1 => tomorrow's data
        #   But we'll note the date of tomorrow for clarity
        tomorrow_date = all_dates[i+1]
        dates_list.append(tomorrow_date)

    X = np.array(X_list, dtype=np.float64)
    Y = np.array(Y_list, dtype=np.float64)
    return X, Y, dates_list

############################################################################
# 4) MODEL TRAINING
############################################################################

def train_model(X, Y):
    base_reg = LinearRegression()
    model = MultiOutputRegressor(base_reg)
    model.fit(X, Y)
    return model

############################################################################
# 5) PREDICT TOMORROW (in this case, 2025-01-03)
############################################################################

def predict_tomorrow(df, model, lookback=5):
    """
    We'll take the last 'lookback' days from df, flatten them as features,
    run model.predict, interpret as [High, Low, Close].
    """
    df_recent = df[["Open","High","Low","Close"]].tail(lookback)
    feats = df_recent.values.flatten().reshape(1, -1)

    pred = model.predict(feats)[0]  # shape (3,)
    pred_high, pred_low, pred_close = pred

    # We'll just print them
    # (Of course if you have rounding or formatting preferences, do so.)
    print("\n=== PREDICTION FOR 2025-01-03 ===")
    print(f"Predicted Low:   {pred_low:.5f}")
    print(f"Predicted High:  {pred_high:.5f}")
    print(f"Predicted Close: {pred_close:.5f}")

############################################################################
# MAIN
############################################################################

def main():
    df = load_gbpjpy_data()
    df = clean_data(df)

    # Build dataset
    lookback = 5
    X, Y, date_info = build_dataset_for_next_day(df, lookback=lookback)
    print(f"Dataset shape: X={X.shape}, Y={Y.shape}")
    print(f"Last 5 items of date_info: {date_info[-5:]}")

    # Train
    model = train_model(X, Y)
    print("\nModel trained on the historical data from 2024-01-02 to 2025-01-02.")

    # Predict tomorrow (2025-01-03)
    predict_tomorrow(df, model, lookback=lookback)

if __name__ == "__main__":
    main()
